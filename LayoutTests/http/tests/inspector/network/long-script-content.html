<html>
<head>
<script src="../inspector-test.js"></script>
<script src="../network-test.js"></script>
<script src="../debugger-test.js"></script>
<script>

var scriptElement;
function loadScript()
{
    scriptElement = document.createElement("script");
    scriptElement.src = "resources/long_script.cgi";
    document.head.appendChild(scriptElement);
}

function unloadScript()
{
    scriptElement.parentElement.removeChild(scriptElement);
}

function test()
{
    InspectorTest.hardReloadPage(step1);

    function generateScript()
    {
        var fib = [8, 18, 2, 28, 59, 41, 34, 27, 16, 13];
        var i = 0;

        var buffer = [];
        for (var x = 0; x < 33; ++x) {
            buffer.push("// ");
            for (var y = 0; y < 1020; ++y) {
                buffer.push(String.fromCharCode(fib[i % 10] + 32));
                fib[i % 10] = (fib[i % 10] + fib[(i + 3) % 10]) % 64;
                i++;
            }
            buffer.push("\n");
        }
        var chunk = buffer.join("");

        buffer = [];
        for (var z = 0; z < 250; ++z)
            buffer.push(chunk);
        return buffer.join("");
    }

    function step1()
    {
        InspectorTest.evaluateInPage("loadScript()", step2);
    }

    function step2()
    {
        InspectorTest.evaluateInPage("unloadScript()", step3);
    }

    function step3()
    {
        InspectorTest.showScriptSource("long_script.cgi", step4);
    }

    function step4(sourceFrame)
    {
        var loadedScript = sourceFrame._textEditor.text();
        var generatedScript = generateScript();
        InspectorTest.assertTrue(loadedScript === generatedScript, "Loaded script doesn't match generated");
        InspectorTest.completeTest();
    }
}
</script>
</head>
<body onload="runTest()">
    <p> Tests long script content is correctly shown in source panel after page reload.</p>
</body>
</html>

