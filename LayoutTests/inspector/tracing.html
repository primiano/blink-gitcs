<html>
<head>
<style>
div#test {
    display: none;
    background-color: blue;
    width: 100px;
    height: 100px;
}
</style>
<script src="../http/tests/inspector/inspector-test.js"></script>
<script>
function doWork()
{
    var element = document.getElementById("test");
    element.style.display = "block";
    var unused = element.clientWidth;
}

function test()
{
    function runEventsSanityCheck(events)
    {
        var phaseComplete = 0;
        var knownEvents = {};
        var processes = {};
        var threads = {};

        knownEvents["MessageLoop::PostTask"] = 0;
        knownEvents["v8.callFunction"] = 0;
        knownEvents["Document::updateRenderTree"] = 0;
        knownEvents["FrameView::layout"] = 0;

        for (var i = 0; i < events.length; ++i) {
            var event = events[i];
            if (event.ph === "X")
                ++phaseComplete;
            if (event.name in knownEvents)
                ++knownEvents[event.name];
            processes[event.pid] = (processes[event.pid] || 0) + 1;
            threads[event.tid] = (threads[event.tid] || 0) + 1;
        }
        InspectorTest.assertGreaterOrEqual(events.length, 100, "Too few trace events recorded");
        InspectorTest.assertGreaterOrEqual(knownEvents["v8.callFunction"], 10, "Too few v8.callFunction");
        InspectorTest.assertGreaterOrEqual(knownEvents["Document::updateRenderTree"], 1, "Too few Document::recalcStyle");
        InspectorTest.assertGreaterOrEqual(knownEvents["FrameView::layout"], 1, "Too few FrameView::layout");
        InspectorTest.assertGreaterOrEqual(phaseComplete, 50, "Too few begin events");
        InspectorTest.assertGreaterOrEqual(Object.keys(processes).length, 2, "Too few processes");
        InspectorTest.assertGreaterOrEqual(Object.keys(threads).length, 4, "Too few threads");
        InspectorTest.addResult("Event sanity test done");
    }

    var events = [];
    function onTraceEvents(event)
    {
        events = events.concat(event.data);
    }

    function onTracingComplete()
    {
        InspectorTest.addResult("Tracing complete");
        WebInspector.tracingAgent.removeEventListener(WebInspector.TracingAgent.Events.EventsCollected, onTraceEvents);
        runEventsSanityCheck(events);
        InspectorTest.completeTest();
    }

    WebInspector.tracingAgent.addEventListener(WebInspector.TracingAgent.Events.EventsCollected, onTraceEvents);
    WebInspector.tracingAgent.start("", "", onTracingStarted);
    function onTracingStarted(error)
    {
        InspectorTest.addResult("Tracing started (error: " + JSON.stringify(error) + ")");
        InspectorTest.evaluateInPage("doWork()", function() {
            WebInspector.tracingAgent.stop(onTracingComplete);
        });
    }
}

</script>
</head>
<body onload="runTest()">
<div id="test">
</div>
</body>
</html>
