<html>
<head>
<script src="../../http/tests/inspector/inspector-test.js"></script>
<script src="../../http/tests/inspector/timeline-test.js"></script>
<script>

function performActions() 
{
    var image = new Image();
    image.src = "resources/anImage.png";
    var script = document.createElement("script");
    script.src = "timeline-network-resource.js";
    document.body.appendChild(script);
}

function test()
{
    var callbackBarrier = new CallbackBarrier();
    var resourceReceivedCallback = callbackBarrier.createCallback();
    // It will be called from timeline-network-resource.js script by evaluateInWebInspector call.
    InspectorTest.scriptEvaluated = callbackBarrier.createCallback();
    callbackBarrier.callWhenDone(done);

    function done()
    {
        InspectorTest.addResult("Script evaluated.");
        InspectorTest.addResult("Resource received data has length, test passed.");
        InspectorTest.completeTest();
    }

    var calledOnce;

    InspectorTest.startTimeline(function() {
        InspectorTest.evaluateInPage("performActions()");
    });

    InspectorTest.waitForRecordType("ResourceReceivedData", finish);

    function finish(object)
    {
        for (var prop in object) {
            if (!InspectorTest.timelinePropertyFormatters[prop]) {
                for (var property in object[prop]) {
                    if (property === "encodedDataLength") {
                        if (!calledOnce) {
                            calledOnce = true;
                            resourceReceivedCallback();
                        }
                        return;
                    }
                }
            }
        }
    }
}

</script>
</head>

<body onload="runTest()">
<p>
Tests the Timeline API instrumentation of a network resource received data
</p>
</body>
</html>
