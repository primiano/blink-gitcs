<html>
<head>
  <script src="../../http/tests/inspector/inspector-test.js"></script>
  <script src="heap-snapshot-test.js"></script>
<script>

function test()
{
    var instanceCount = 200;
    function createHeapSnapshot()
    {
        return InspectorTest.createHeapSnapshot(instanceCount, 100);
    }

    InspectorTest.runHeapSnapshotTestSuite([
        function testSearch(next)
        {
            InspectorTest.takeAndOpenSnapshot(createHeapSnapshot, step1);

            function step1()
            {
                InspectorTest.switchToView("Summary", step2);
            }

            var view;
            function addNodeHighlightSniffer(constructorName, nodeId, onSuccess)
            {
                InspectorTest.addSniffer(view, "_didHighlightById", checkNodeIsHighlighted.bind(view, constructorName, nodeId, onSuccess));
            }

            function step2()
            {
                view = InspectorTest.currentProfileView();
                addNodeHighlightSniffer("A", "101", step3);
                view.performSearch({query:"@101", caseSensitive: false});
            }

            function step3()
            {
                view.performSearch({query: "@a", caseSensitive: false});
                if (view._searchResults.length !== 0) {
                    InspectorTest.addResult("FAIL: node @a found");
                    return next();
                }
                InspectorTest.addResult("PASS: node @a was not found");
                InspectorTest.addSniffer(view, "_didHighlightById", step5);
                view.performSearch({query: "@999", caseSensitive: false}, step5);
            }

            function step5(found)
            {
                if (found) {
                    InspectorTest.addResult("FAIL: found node @999");
                    return next();
                }
                InspectorTest.addResult("PASS: node @999 was not found");
                addNodeHighlightSniffer("B", "100", step6);
                view.performSearch({query: "@100", caseSensitive: false});
            }

            function step6()
            {
                addNodeHighlightSniffer("B", "400", step7);
                view.performSearch({query: "@400", caseSensitive: false});
            }

            function step7()
            {
                addNodeHighlightSniffer("A", "401", next);
                view.performSearch({query: "@401", caseSensitive: false});
            }

            function checkNodeIsHighlighted(constructorName, nodeId, onSuccess, found)
            {
                if (!found) {
                    InspectorTest.addResult("FAIL: node @" + nodeId + " not found");
                    return next();
                }
                try {
                    var constructorsGrid = InspectorTest.currentProfileView()._dataGrid;
                    var constructorNodes = constructorsGrid.rootNode().children;
                    var constructorNode;
                    for (var i = 0; i < constructorNodes.length; i++) {
                        if (constructorNodes[i].data.object === constructorName) {
                            constructorNode = constructorNodes[i];
                            break;
                        }
                    }
                    if (!constructorNode) {
                        InspectorTest.addResult("FAIL: constructor " + constructorName + " not found in viewport");
                        return next();
                    }
                    var instanceNodes = constructorNode.children;
                    for (var i = 0; i < instanceNodes.length; i++) {
                        if (instanceNodes[i].snapshotNodeId == nodeId) {
                            if (!instanceNodes[i].element().classList.contains("highlighted-row")) {
                                if (constructorsGrid._nodeToHighlightAfterScroll === instanceNodes[i]) {
                                    function afterScroll(nodeToHighlight)
                                    {
                                        InspectorTest.addResult("PASS: found node @" + nodeId + " with class '" + constructorName + "'");
                                        onSuccess();
                                    }
                                    InspectorTest.addSniffer(WebInspector.HeapSnapshotSortableDataGrid.prototype, "highlightNode", afterScroll);
                                    return;
                                } else {
                                    InspectorTest.addResult("FAIL: node is not highlighted");
                                    return next();
                                }
                            }
                            InspectorTest.addResult("PASS: found node @" + nodeId + " with class '" + constructorName + "'");
                            return onSuccess();
                        }
                    }
                } catch (e) {
                    InspectorTest.addResult("EXCEPTION: " + e);
                }
                return next();
            }
        }
    ]);
}

</script>
</head>
<body onload="runTest()">
<p>
Tests search in Summary view of detailed heap snapshots.
</p>
</body>
</html>
