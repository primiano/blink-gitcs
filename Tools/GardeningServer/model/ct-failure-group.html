<!--
Copyright 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="ct-commit-list.html">

<script>
function CTFailureGroup(key, failures, annotation) {
  this.key = key;
  this.failures = failures;
  this._annotation = annotation || {};
  this._computeProperties();
}

CTFailureGroup.prototype.snoozeUntil = function(time) {
  return this._annotate({
    snoozeTime: time,
  });
};

CTFailureGroup.prototype.unsnooze = function() {
  return this._annotate({
    snoozeTime: undefined,
  });
};

CTFailureGroup.prototype.commitList = function(commits) {
  return new CTCommitList(this, commits);
};

CTFailureGroup.prototype.setBug = function(bug) {
  if (/^[0-9]+$/.test(bug))
    bug = 'http://crbug.com/' + bug;
  return this._annotate({
    bug: bug,
  });
};

CTFailureGroup.prototype.clearBug = function(bug) {
  return this._annotate({
    bug: undefined,
  });
};

CTFailureGroup.prototype._computeProperties = function() {
  this.isSnoozed = Date.now() < this._annotation.snoozeTime;
  if (this.isSnoozed) {
    this.category = 'snoozed';
  } else {
    // FIXME: crbug.com/400397 Split into: Whole step failure, Tree closer, Test failure, Flaky tests
    this.category = 'default';
  }

  this.bug = this._annotation.bug;
  if (this.bug !== undefined)
    this.bugLabel = 'Bug ' + /([0-9]{3,})/.exec(this.bug)[0];
  else
    this.bugLabel = undefined;
};

CTFailureGroup.prototype._annotate = function(newAnnotation) {
  // FIXME: Post the new annotation to frontend rather than storing locally.
  return CTFailureGroup.fetchAnnotations().then(function(annotations) {
    var annotation = annotations[this.key] || {};

    Object.keys(newAnnotation, function(key, value) {
      if (value === 'undefined') {
        delete annotation[key];
      } else {
        annotation[key] = value;
      }
    });

    if (Object.size(annotation) == 0) {
      delete annotations[this.key];
    } else {
      annotations[this.key] = annotation;
    }

    localStorage.CTFailureGroupAnnotations = JSON.stringify(annotations);

    this._annotation = annotation;
    this._computeProperties();
  }.bind(this));
};

CTFailureGroup.fetchAnnotations = function() {
  // FIXME: Fetch annotations from frontend.
  var stored = localStorage.CTFailureGroupAnnotations;
  var annotations = stored ? JSON.parse(stored) : {};
  return Promise.resolve(annotations);
};
</script>
