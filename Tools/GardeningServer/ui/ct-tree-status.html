<!--
Copyright 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<polymer-element name="ct-tree-status">
  <template>
    <style>
      :host {
        display: flex;
      }

      :host([status=throttled]) {
        background-color: #fffc6c;
      }

      :host([status=closed]),
      :host([status=closed]) a {
        color: white;
        background-color: #e98080;
      }

      .message {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    </style>
    <template if="{{ message }}">
      <div class="message">{{ project }}: {{ message }}</div>
      <div style="padding: 0 5px;">[ <a href="{{ project | _url }}">details</a> ]</div>
    </template>
  </template>
  <script>
    Polymer({
      publish: {
        project: '',
        message: '',
        status: {
          value: '',
          reflect: true,
        },
      },

      _url: function(project) {
        return treestatus.urlByName(this.project);
      },

      update: function() {
        var url = this._url(this.project) + 'current?format=json';
        return net.json(url).then(function(response) {
          this.updateStatus(response);
        }.bind(this));
      },

      updateStatus: function(status) {
        if (status.can_commit_freely) {
          this.message = null;
          this.status = 'open';
          return;
        }

        this.message = status.message + ' by ' + status.username;
        var responseLowerCase = status.message.toLowerCase();
        if (responseLowerCase.indexOf('throttled') != -1) {
          this.status = 'throttled';
        } else if (responseLowerCase.indexOf("closed") != -1) {
          this.status = 'closed';
        } else {
          this.status = 'unknown';
        }
      },
    });
  </script>
</polymer-element>
