<!--
Copyright 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="../ct-failure-analyzer.html">

<script>
(function () {

var assert = chai.assert;

describe('ct-failure-analyzer', function() {
  describe('_failureComparator', function() {
    it('should sort failures', function() {
      var analyzer = document.createElement('ct-failure-analyzer');
      var resultsByBuilder = {};
      var failure1 = new CTFailure("step1", "reason1", resultsByBuilder, 123, 123);
      var failure2 = new CTFailure("step1", "reason2", resultsByBuilder, 123, 123);
      var failure3 = new CTFailure("step1", "reason3", resultsByBuilder, 123, 123);
      var failure4 = new CTFailure("step2", "reason1", resultsByBuilder, 123, 123);

      var failures = [failure4, failure3, failure2, failure1];
      var expectedFailures = [failure1, failure2, failure3, failure4];
      assert.deepEqual(failures.sort(analyzer._failureComparator), expectedFailures);
    });
  });

  describe('_failureListComparator', function() {
    it('should compare failures correctly', function() {
      var analyzer = document.createElement('ct-failure-analyzer');
      var revision1 = {
        'chromium': 1,
        'blink': 2
      };
      var revision2 = {
        'chromium': 2,
        'blink': 1
      };
      var revision3 = {
        'chromium': 2,
        'blink': 2
      };
      var resultsByBuilder = {};
      var failure1 = new CTFailure("step", "reason", resultsByBuilder, revision1, revision1);
      var failure2 = new CTFailure("step", "reason", resultsByBuilder, revision2, revision2);
      var failure3 = new CTFailure("step", "reason", resultsByBuilder, revision3, revision3);
      var failure4 = new CTFailure("step", "reason", resultsByBuilder, null, null);
      var group1 = new CTFailureGroup("0", [failure1], null);
      var group2 = new CTFailureGroup("1", [failure2], null);
      var group3 = new CTFailureGroup("2", [failure3], null);
      var group4 = new CTFailureGroup("3", [failure4], null);

      // Sort by last revision first.
      assert(analyzer._failureListComparator('chromium', group1, group2) > 0);
      assert(analyzer._failureListComparator('chromium', group2, group1) < 0);
      assert(analyzer._failureListComparator('chromium', group1, group1) == 0);

      // If the tree revisions are equal, take others.
      assert(analyzer._failureListComparator('chromium', group2, group3) > 0);

      // Prioritize the given tree.
      assert(analyzer._failureListComparator('chromium', group1, group2) > 0);
      assert(analyzer._failureListComparator('blink', group1, group2) < 0);

      // Default to 'chromium'.
      assert(analyzer._failureListComparator(undefined, group1, group2) > 0);

      // Failures without a revision go to the end.
      assert(analyzer._failureListComparator('chromium', group4, group1) < 0);
    });
  });
});

})()
</script>
