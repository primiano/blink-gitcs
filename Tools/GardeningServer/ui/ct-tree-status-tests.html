<!--
Copyright 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="ct-tree-status.html">

<script>
(function () {

module("ct-tree-status");

openTreeJson = {
  "username": "username@test.org",
  "message": "Tree is open",
  "can_commit_freely": true
}

throttledTreeJson = {
  "username": "username@test.org",
  "message": "Tree is throttled just for fun",
  "can_commit_freely": false
}

closedTreeJson = {
  "username": "username@test.org",
  "message": "Tree is closed for maintenance",
  "can_commit_freely": false
}

asyncTest("basic", 10, function() {
  var simulator = new NetworkSimulator();
  simulator.json = function(url) {
    if (url.indexOf('closed') != -1)
      return Promise.resolve(closedTreeJson);
    else if (url.indexOf('throttled') != -1)
      return Promise.resolve(throttledTreeJson);
    else
      return Promise.resolve(openTreeJson);
  };

  var opentree = document.createElement("ct-tree-status");
  opentree.project = "open-tree-project";
  var throttledtree = document.createElement("ct-tree-status");
  throttledtree.project = "throttled-tree-project";
  var closedtree = document.createElement("ct-tree-status");
  closedtree.project = "closed-tree-project";

  simulator.runTest(function() {
    var urlByName = treestatus.urlByName;
    treestatus.urlByName = function(name) {
      return "http://" + name + "-status.appspot.com/";
    }
    Promise.all([
      opentree.update().then(function() {
        equal(opentree.status, "open");
      }),
      throttledtree.update().then(function() {
        equal(throttledtree.message,
              "Tree is throttled just for fun by username@test.org");
        equal(throttledtree.status, "throttled");
      }),
      closedtree.update().then(function() {
        equal(closedtree.message,
              "Tree is closed for maintenance by username@test.org");
        equal(closedtree.status, "closed");
        equal(closedtree.shadowRoot.querySelector('a').href, treestatus.urlByName('closed-tree-project'));
      })
    ]).then(function() {
      requestAnimationFrame(function() {
        ok(!opentree.shadowRoot.textContent.has("open-tree-project"));
        ok(throttledtree.shadowRoot.textContent.has("throttled-tree-project"));
        ok(closedtree.shadowRoot.textContent.has("closed-tree-project"));
        start();
        treestatus.urlByName = urlByName;
      });
    });
  });
});

})();
</script>
