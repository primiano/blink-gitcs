<!--
Copyright 2014 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="ct-results-detail.html">

<link rel="import" href="../model/ct-failure.html">

<script>
(function () {

module("ct-results-detail");

asyncTest("image+text", 4, function() {
  var simulator = new NetworkSimulator();
  var probedUrls = [];

  simulator.probe = function(url)
  {
    probedUrls.push(url);
    if (url.endsWith('.txt') || url.endsWith('.png'))
        return Promise.resolve();
    else
        return Promise.reject();
  };

  simulator.runTest(function() {
    var comparisonResult = document.createElement('ct-results-detail');
    comparisonResult.builder = 'dummy builder';
    // FIXME: Use a proper mock model object.
    comparisonResult.failure = {
      "testName": "dummy/test.html",
      "resultNodesByBuilder": {
        "dummy builder": {
          "actual": "IMAGE+TEXT",
        },
      },
      "oldestFailingRevision": 177164,
      "newestPassingRevision": 177165,
    };

    comparisonResult.async(function() {
      deepEqual(probedUrls, [
          'https://storage.googleapis.com/chromium-layout-test-archives/dummy_builder/results/layout-test-results/dummy/test-expected.png',
          'https://storage.googleapis.com/chromium-layout-test-archives/dummy_builder/results/layout-test-results/dummy/test-actual.png',
          'https://storage.googleapis.com/chromium-layout-test-archives/dummy_builder/results/layout-test-results/dummy/test-diff.png',
          'https://storage.googleapis.com/chromium-layout-test-archives/dummy_builder/results/layout-test-results/dummy/test-actual.txt',
          'https://storage.googleapis.com/chromium-layout-test-archives/dummy_builder/results/layout-test-results/dummy/test-expected.txt',
          'https://storage.googleapis.com/chromium-layout-test-archives/dummy_builder/results/layout-test-results/dummy/test-diff.txt',
      ]);

      var comparisons = comparisonResult.shadowRoot.querySelectorAll('ct-results-comparison');
      equal(comparisons.length, 2);
      equal(comparisonResult.shadowRoot.querySelectorAll('ct-test-output').length, 0);

      start();
    });
  });
});

asyncTest("crash", 4, function() {
  var simulator = new NetworkSimulator();
  var probedUrls = [];

  simulator.probe = function(url)
  {
    probedUrls.push(url);
    if (url.endsWith('.txt'))
        return Promise.resolve();
    else
        return Promise.reject();
  };

  simulator.runTest(function() {
    var crashResult = document.createElement('ct-results-detail');
    crashResult.builder = 'dummy builder';
    // FIXME: Use a proper mock model object.
    crashResult.failure = {
      "testName": "dummy/test.html",
      "resultNodesByBuilder": {
        "dummy builder": {
          "actual": "CRASH",
        },
      },
      "oldestFailingRevision": 177164,
      "newestPassingRevision": 177165,
    };

    crashResult.async(function() {
      deepEqual(probedUrls, [
          'https://storage.googleapis.com/chromium-layout-test-archives/dummy_builder/results/layout-test-results/dummy/test-crash-log.txt',
      ]);

      var crashOutputs = crashResult.shadowRoot.querySelectorAll('ct-test-output');
      equal(crashOutputs.length, 1);
      equal(crashResult.shadowRoot.querySelectorAll('ct-results-comparison').length, 0);
      start();
    });
  });
});

asyncTest("unknown", 3, function() {
  var result = document.createElement('ct-results-detail');

  result.builder = 'dummy builder';

  var resultsByBuilder = {
    "dummy builder": {
      actual: "UNKNOWN",
      lastFailingBuild: 124,
      masterUrl: 'http://masterurl/'
    },
  };
  result.failure = new CTFailure('foo_step', 'test.html', resultsByBuilder, 123, 124);

  requestAnimationFrame(function() {
    var outputs = result.shadowRoot.querySelectorAll('ct-test-output');
    equal(outputs.length, 1);
    equal(outputs[0].url, 'http://masterurl//builders/dummy%20builder/builds/124/steps/foo_step/logs/stdio');
    equal(result.shadowRoot.querySelectorAll('ct-results-comparison').length, 0);
    start();
  });
});

asyncTest("unknown", 3, function() {
  var result = document.createElement('ct-results-detail');

  result.builder = 'dummy builder';

  var resultsByBuilder = {
    "dummy builder": {
      actual: "FAIL",
      lastFailingBuild: 124,
      masterUrl: 'http://masterurl/'
    },
  };
  result.failure = new CTFailure('foo_step', 'TestSuite.TestName', resultsByBuilder, 123, 124);

  requestAnimationFrame(function() {
    var outputs = result.shadowRoot.querySelectorAll('ct-test-output');
    equal(outputs.length, 1);
    equal(outputs[0].url, 'http://masterurl//builders/dummy%20builder/builds/124/steps/foo_step/logs/TestName');
    equal(result.shadowRoot.querySelectorAll('ct-results-comparison').length, 0);
    start();
  });
});

})()
</script>
